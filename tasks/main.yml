---
- name: Install packages
  apt:
    name: "{{ item }}"
    state: latest
  with_items: "{{ _deploy_packages }}"

- name: Clone repository
  git:
    repo: "{{ deploy_git_repo }}"
    dest: "{{ deploy_dest }}"
    version: "{{ deploy_version }}"
    key_file: "{{ deploy_ssh_key }}"
    accept_hostkey: true
    ssh_opts: "-o StrictHostKeyChecking=no"
    force: yes

- name: Set config <core.fileMode> for repository
  git_config:
    name: core.fileMode
    value: false
    scope: local
    repo: "{{ deploy_dest }}"

- name: Check if composer packages directory exists
  stat:
    path: "{{ deploy_composer_packages_path }}"
  register: _deploy_composer_packages_path_info
  when: deploy_composer_path is defined

- name: Create composer packages directory
  file:
    path: "{{ deploy_composer_packages_path }}"
    state: directory
    mode: 0777
  when: deploy_composer_path is defined and not _deploy_composer_packages_path_info.stat.exists

- name: Install composer packages
  composer:
    command: install
    working_dir: "{{ deploy_composer_path | dirname }}"
    no_dev: "{{ 'yes' if deploy_env == 'prod' else 'no' }}"
  become: no
  when: deploy_composer_path is defined

- name: Check if npm packages directory exists
  stat:
    path: "{{ deploy_npm_packages_path }}"
  register: _deploy_npm_packages_path_info
  when: deploy_npm_path is defined

- name: Create npm packages directory
  file:
    path: "{{ deploy_npm_packages_path }}"
    state: directory
    mode: 0777
  when: deploy_npm_path is defined and not _deploy_npm_packages_path_info.stat.exists

- name: Install npm packages
  npm:
    path: "{{ deploy_npm_path | dirname }}"
  become: no
  when: deploy_npm_path is defined

- name: Include deploy hook
  include_tasks: "{{ deploy_hook }}"
  when: deploy_hook is defined